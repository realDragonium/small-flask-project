version: "3.9"


services:
  production:
    build: .
    ports:
      - 5000:5000
    command: ["pipenv", "run", "python", "app.py"]
    environment:
      MODE: "production"
      ENV: "production"


  development:
    build: .
    ports:
      - 5000:5000
    command: ["pipenv", "run", "python", "app.py"]
    environment:
      MODE: "development"
      ENV: "development"


  unit:
    build:
      context: .
      dockerfile: unittest.dockerfile
    command: ["python", "test_unit.py"]
    environment:
      MODE: "unit"
      DATABASE: "MEMORY"


  integration:
    build: .
    command: ["python", "integration_tests.py"]
    depends_on:
      - integration_db
    networks:
      - integration
    environment:
      MODE: "integration"
      DATABASE: "SQL"
      DB_URL: "integration_db:5432"
      DB_USER: 'DONT_LEAVE_ME_ALONE'
      DB_PASS: 'CHANGE_ME'

  integration_db:
    image: postgres:13.3
    environment:
      POSTGRES_USER: 'DONT_LEAVE_ME_ALONE'
      POSTGRES_PASSWORD: 'CHANGE_ME'
    networks:
      - integration


networks:
  integration:
    driver: bridge
    name: integration
